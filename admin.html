<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <title>WHSScienceMC Admin</title>
    <style>
        body {
            background: #202020;
            color: white;
            font-family: Arial, sans-serif;
            text-align: center;
            padding: 3rem;
        }

        button {
            margin: 1rem;
            padding: 0.8rem 1.5rem;
            font-size: 1rem;
        }

        #admin-section {
            display: block;
            margin-top: 2rem;
        }
    </style>
</head>

<body>
    <h1>WHSScienceMC Admin Portal</h1>

    <!-- Shared login buttons from main.js -->
    <div id="auth-controls">
        <button id="loginBtn">Sign In with Google</button>
        <button id="logoutBtn" style="display:none;">Sign Out</button>
        <div id="status"></div>
    </div>

    <!-- Admin-only section -->
    <div id="admin-section">
        <h2>Admin Dashboard</h2>
        <p>✅ Logged in as <span id="user-name"></span></p>
    
        <button id="export-btn">Download responses Excel</button>
        <p id="export-status"></p>
    </div>


    <!-- Reuse your existing logic -->
    <script type="module" src="./js/main.js"></script>
    <script>
        // Backend URL (non-secret)
        const BACKEND_BASE_URL = "https://whs-science-mc.onrender.com";

        // DOM elements
        const adminSection = document.getElementById("admin-section");
        const status = document.getElementById("status");
        const userNameSpan = document.getElementById("user-name");
        const exportBtn = document.getElementById("export-btn");
        const exportStatus = document.getElementById("export-status");

            // Show/hide admin section based on auth state.
            // We poll until main.js has put auth + onAuthStateChanged on window.
            function setupAdminAuthListener() {
                if (!window.auth || !window.onAuthStateChanged) {
                    // Try again shortly – main.js may not have finished initialising yet.
                    setTimeout(setupAdminAuthListener, 200);
                    return;
                }

                window.onAuthStateChanged(window.auth, (user) => {
                    if (user && user.email && user.email.endsWith("@education.nsw.gov.au")) {
                        adminSection.style.display = "block";
                        userNameSpan.textContent = user.displayName || user.email;
                        status.textContent = "";
                    } else {
                        adminSection.style.display = "none";
                        status.textContent = "Please sign in with your DoE account.";
                    }
                });
            }

            // Start polling for auth being ready
            setupAdminAuthListener();


        async function downloadExcel() {
            try {
                exportStatus.textContent = "Generating report...";

                const auth = window.auth;
                const user = auth?.currentUser;

                if (!user) {
                    exportStatus.textContent = "Not signed in. Please log in first.";
                    return;
                }

                // Get a fresh ID token for this user
                const idToken = await user.getIdToken();

                // For now we export from the 'responses' collection
                const collectionPath = "responses";

                const response = await fetch(
                    `${BACKEND_BASE_URL}/api/export?collection=${encodeURIComponent(collectionPath)}`,
                    {
                        method: "GET",
                        headers: {
                            Authorization: `Bearer ${idToken}`,
                        },
                    }
                );

                if (!response.ok) {
                    if (response.status === 401 || response.status === 403) {
                        exportStatus.textContent = "You are not authorised to export this data.";
                    } else {
                        const text = await response.text().catch(() => "");
                        exportStatus.textContent =
                            `Export failed (HTTP ${response.status}). ${text || ""}`;
                    }
                    return;
                }

                const blob = await response.blob();
                const downloadUrl = window.URL.createObjectURL(blob);

                const a = document.createElement("a");
                a.href = downloadUrl;
                a.download = `${collectionPath}-export.xlsx`;
                document.body.appendChild(a);
                a.click();
                a.remove();

                window.URL.revokeObjectURL(downloadUrl);
                exportStatus.textContent = "Export complete. File downloaded.";
            } catch (err) {
                console.error(err);
                exportStatus.textContent = "Export failed: " + err.message;
            }
        }

        if (exportBtn) {
            exportBtn.addEventListener("click", downloadExcel);
        }
    </script>

</body>

</html>