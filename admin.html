<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <title>WHSScienceMC Admin</title>
    <style>
        body {
            background: #202020;
            color: white;
            font-family: Arial, sans-serif;
            text-align: center;
            padding: 3rem;
        }

        button {
            margin: 1rem;
            padding: 0.8rem 1.5rem;
            font-size: 1rem;
        }

        #admin-section {
            display: block;
            /* keep it always visible */
            margin-top: 2rem;
        }

        .section-block {
            margin-top: 2rem;
            border-top: 1px solid #444;
            padding-top: 1.5rem;
        }
    </style>
</head>

<body>
    <h1>WHSScienceMC Admin Portal</h1>

    <!-- Shared login buttons from main.js -->
    <div id="auth-controls">
        <button id="loginBtn">Sign In with Google</button>
        <button id="logoutBtn" style="display:none;">Sign Out</button>
        <div id="status"></div>
    </div>

    <!-- Admin section -->
    <div id="admin-section">
        <h2>Admin Dashboard</h2>
        <p>âœ… Logged in as <span id="user-name"></span></p>


        <div class="section-block">
            <h3>Export Sentral Markbook (T1)</h3>
            <p>
                Quiz ID: <code>task1_2025</code> (hard-coded for now)<br>
                Sci class filter (optional, e.g. <code>7Sci3</code> or <code>10SciASP</code>):
            </p>
            <input type="text" id="sentralClassFilter" placeholder="Leave blank for all classes">
            <br>
            <button id="sentral-export-btn">Download Sentral T1 Excel</button>
            <p id="sentral-export-status"></p>
        </div>
        

        <div class="section-block">
            <h3>Student Report (PDF)</h3>
            <p>
                Enter the quiz ID, class and student email to download a PDF report
                for that student and task.
            </p>
            <p>
                Quiz ID (e.g. <code>task1_2025</code>):
                <br>
                <input type="text" id="sr-quizId" placeholder="task1_2025">
            </p>
            <p>
                Sci class (e.g. <code>10SciASP</code>):
                <br>
                <input type="text" id="sr-sciClass" placeholder="10SciASP">
            </p>
            <p>
                Student email (must match roster + responses):
                <br>
                <input type="email" id="sr-studentEmail" placeholder="student@education.nsw.gov.au">
            </p>
        
            <button id="sr-generate">Download Student Report (PDF)</button>
            <p id="sr-status"></p>
        </div>



        <div class="section-block">
            <h3>Export responses</h3>
            <button id="export-btn">Download responses Excel</button>
            <p id="export-status"></p>
        </div>

        <div class="section-block">
            <h3>Upload roster (email, givenName, familyName, yearLevel, sciClass)</h3>
            <input type="file" id="rosterFile" accept=".xls,.xlsx" />
            <button id="uploadRosterBtn">Upload roster</button>
            <p id="roster-upload-status"></p>
        </div>
        
    </div>

    <!-- Load shared logic (login buttons, UI updates, etc.) -->
    <script type="module" src="./js/main.js"></script>

    <!-- Admin-specific logic -->
    <script type="module">
        // Import Firebase Auth directly so admin.html does not depend on globals
        import { auth } from "./js/firebase-init.js";
        import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";

        const BACKEND_BASE_URL = "https://whs-science-mc.onrender.com";

        // DOM elements
        const userNameSpan = document.getElementById("user-name");
        const exportBtn = document.getElementById("export-btn");
        const exportStatus = document.getElementById("export-status");

        const sentralClassFilterInput = document.getElementById("sentralClassFilter");
        const sentralExportBtn = document.getElementById("sentral-export-btn");
        const sentralExportStatus = document.getElementById("sentral-export-status");

        const rosterFileInput = document.getElementById("rosterFile");
        const uploadRosterBtn = document.getElementById("uploadRosterBtn");
        const rosterUploadStatus = document.getElementById("roster-upload-status");

        const srQuizIdInput = document.getElementById("sr-quizId");
        const srSciClassInput = document.getElementById("sr-sciClass");
        const srStudentEmailInput = document.getElementById("sr-studentEmail");
        const srGenerateBtn = document.getElementById("sr-generate");
        const srStatus = document.getElementById("sr-status");


        let currentUser = null;

        // Watch for login/logout
        onAuthStateChanged(auth, (user) => {
            currentUser = user || null;

            if (user) {
                userNameSpan.textContent = user.displayName || user.email;
            } else {
                userNameSpan.textContent = "(not signed in)";
            }
        });

        // -------- Export handler (unchanged) --------
        async function downloadExcel() {
            exportStatus.textContent = "Generating report...";

            if (!currentUser) {
                exportStatus.textContent = "Not signed in. Please log in first.";
                return;
            }

            try {
                const idToken = await currentUser.getIdToken();
                const collectionPath = "responses";

                const response = await fetch(
                    `${BACKEND_BASE_URL}/api/export?collection=${encodeURIComponent(collectionPath)}`,
                    {
                        method: "GET",
                        headers: { Authorization: `Bearer ${idToken}` },
                    }
                );

                if (!response.ok) {
                    if (response.status === 401 || response.status === 403) {
                        exportStatus.textContent = "You are not authorised to export this data.";
                    } else {
                        const text = await response.text().catch(() => "");
                        exportStatus.textContent =
                            `Export failed (HTTP ${response.status}). ${text || ""}`;
                    }
                    return;
                }

                const blob = await response.blob();
                const downloadUrl = window.URL.createObjectURL(blob);

                const a = document.createElement("a");
                a.href = downloadUrl;
                a.download = `${collectionPath}-export.xlsx`;
                document.body.appendChild(a);
                a.click();
                a.remove();

                window.URL.revokeObjectURL(downloadUrl);
                exportStatus.textContent = "Export complete. File downloaded.";
            } catch (err) {
                console.error(err);
                exportStatus.textContent = "Export failed: " + err.message;
            }
        }

        exportBtn.addEventListener("click", downloadExcel);

        // -------- Roster upload handler (new) --------
        async function uploadRoster() {
            rosterUploadStatus.textContent = "";

            if (!currentUser) {
                rosterUploadStatus.textContent = "Not signed in. Please log in first.";
                return;
            }

            const file = rosterFileInput.files[0];
            if (!file) {
                rosterUploadStatus.textContent = "Please choose an .xls or .xlsx file first.";
                return;
            }

            try {
                rosterUploadStatus.textContent = "Uploading roster...";

                const idToken = await currentUser.getIdToken();
                const formData = new FormData();
                formData.append("file", file);

                const response = await fetch(`${BACKEND_BASE_URL}/api/roster-upload`, {
                    method: "POST",
                    headers: {
                        Authorization: `Bearer ${idToken}`,
                        // Don't set Content-Type manually; browser sets multipart boundary
                    },
                    body: formData,
                });

                if (!response.ok) {
                    const text = await response.text().catch(() => "");
                    rosterUploadStatus.textContent =
                        `Roster upload failed (HTTP ${response.status}). ${text || ""}`;
                    return;
                }

                const result = await response.json();
                rosterUploadStatus.textContent =
                    `Roster upload complete. Processed: ${result.processed}, Skipped: ${result.skipped}.`;
            } catch (err) {
                console.error("Roster upload error:", err);
                rosterUploadStatus.textContent = "Roster upload failed: " + err.message;
            }
        }

        uploadRosterBtn.addEventListener("click", uploadRoster);


        // -------- Sentral Markbook export (T1) --------
            async function downloadSentralMarkbook() {
                sentralExportStatus.textContent = "";

                if (!currentUser) {
                    sentralExportStatus.textContent = "Not signed in. Please log in first.";
                    return;
                }

                try {
                    sentralExportStatus.textContent = "Generating Sentral file...";

                    const idToken = await currentUser.getIdToken();

                    const quizId = "task1_2025"; // hard-coded for now
                    let url = `${BACKEND_BASE_URL}/api/export-sentral?quizId=${encodeURIComponent(quizId)}`;

                    const sciClass = (sentralClassFilterInput?.value || "").trim();
                    if (sciClass) {
                        url += `&sciClass=${encodeURIComponent(sciClass)}`;
                    }

                    const response = await fetch(url, {
                        method: "GET",
                        headers: { Authorization: `Bearer ${idToken}` },
                    });

                    if (!response.ok) {
                        const text = await response.text().catch(() => "");
                        if (response.status === 404) {
                            sentralExportStatus.textContent =
                                `No data to export (HTTP 404). ${text || ""}`;
                        } else if (response.status === 401 || response.status === 403) {
                            sentralExportStatus.textContent =
                                "You are not authorised to export Sentral data.";
                        } else {
                            sentralExportStatus.textContent =
                                `Sentral export failed (HTTP ${response.status}). ${text || ""}`;
                        }
                        return;
                    }

                    const blob = await response.blob();
                    const downloadUrl = window.URL.createObjectURL(blob);

                    const sciSafe = sciClass ? `_class-${sciClass}` : "_all-classes";
                    const fileName = `sentral_T1_${quizId}${sciSafe}.xlsx`;

                    const a = document.createElement("a");
                    a.href = downloadUrl;
                    a.download = fileName;
                    document.body.appendChild(a);
                    a.click();
                    a.remove();

                    window.URL.revokeObjectURL(downloadUrl);
                    sentralExportStatus.textContent = "Sentral export complete. File downloaded.";
                } catch (err) {
                    console.error("Sentral export error (frontend):", err);
                    sentralExportStatus.textContent = "Sentral export failed: " + err.message;
                }
            }

            if (sentralExportBtn) {
                sentralExportBtn.addEventListener("click", downloadSentralMarkbook);
            }

            if (srGenerateBtn) {
                    srGenerateBtn.addEventListener("click", downloadStudentReport);
            }


            // -------- Student Report PDF export --------
                async function downloadStudentReport() {
                    srStatus.textContent = "";

                    if (!currentUser) {
                        srStatus.textContent = "Not signed in. Please log in first.";
                        return;
                    }

                    const quizId = (srQuizIdInput?.value || "").trim();
                    const sciClass = (srSciClassInput?.value || "").trim();
                    const studentEmail = (srStudentEmailInput?.value || "").trim().toLowerCase();

                    if (!quizId || !sciClass || !studentEmail) {
                        srStatus.textContent = "Please enter quiz ID, sci class and student email.";
                        return;
                    }

                    try {
                        srStatus.textContent = "Generating student report...";

                        const idToken = await currentUser.getIdToken();

                        const url =
                            `${BACKEND_BASE_URL}/api/student-report` +
                            `?quizId=${encodeURIComponent(quizId)}` +
                            `&sciClass=${encodeURIComponent(sciClass)}` +
                            `&studentEmail=${encodeURIComponent(studentEmail)}`;

                        const response = await fetch(url, {
                            method: "GET",
                            headers: {
                                Authorization: `Bearer ${idToken}`,
                            },
                        });

                        if (!response.ok) {
                            const text = await response.text().catch(() => "");
                            if (response.status === 401 || response.status === 403) {
                                srStatus.textContent = "You are not authorised to generate this report.";
                            } else if (response.status === 404) {
                                srStatus.textContent = `No data found for that student/quiz/class (HTTP 404). ${text || ""}`;
                            } else {
                                srStatus.textContent =
                                    `Student report failed (HTTP ${response.status}). ${text || ""}`;
                            }
                            return;
                        }

                        const blob = await response.blob();
                        const downloadUrl = window.URL.createObjectURL(blob);

                        const safeEmail = studentEmail.replace(/[^a-z0-9_\-]+/gi, "_");
                        const fileName = `StudentReport_${safeEmail}_${quizId}.pdf`;

                        const a = document.createElement("a");
                        a.href = downloadUrl;
                        a.download = fileName;
                        document.body.appendChild(a);
                        a.click();
                        a.remove();

                        window.URL.revokeObjectURL(downloadUrl);
                        srStatus.textContent = "Student report downloaded.";
                    } catch (err) {
                        console.error("Student report error (frontend):", err);
                        srStatus.textContent = "Student report failed: " + err.message;
                    }
                }


    </script>

</body>

</html>